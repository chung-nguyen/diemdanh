<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Face Descriptor Sender</title>
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
  <style>
    video { border: 2px solid #ccc; width: 480px; height: 360px; }
    body { font-family: sans-serif; padding: 20px; }
  </style>
</head>
<body>
  <h2>Live Face Descriptor Sender</h2>
  <video id="video" autoplay muted playsinline></video>
  <div id="log"></div>

  <script>
    const video = document.getElementById('video');
    const log = document.getElementById('log');

    async function init() {
      await faceapi.nets.ssdMobilenetv1.loadFromUri('/models');
      await faceapi.nets.faceLandmark68Net.loadFromUri('/models');
      await faceapi.nets.faceRecognitionNet.loadFromUri('/models');
      log.textContent = '‚úÖ Models loaded';

      // Start video stream
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;

      // Analyze face every 1 second
      setInterval(async () => {
        const detection = await faceapi
          .detectSingleFace(video)
          .withFaceLandmarks()
          .withFaceDescriptor();

        if (!detection) {
          log.textContent = '‚ö†Ô∏è No face detected';
          return;
        }

        const descriptor = Array.from(detection.descriptor); // Convert Float32Array ‚Üí array

        log.textContent = 'üì§ Sending descriptor...';

        // Send to server
        fetch('/api/recognize', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ descriptor })
        })
        .then(res => res.json())
        .then(data => {
          log.textContent = `‚úÖ Server response: ${data.name}`;
        })
        .catch(err => {
          console.error(err);
          log.textContent = '‚ùå Error sending descriptor';
        });
      }, 1000);
    }

    init().catch(console.error);
  </script>
</body>
</html>